EPUBcfi.Parser=function(){function C(f){return'"'+f.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var n={parse:function(f,m){function g(a){b<q||(b>q&&(q=b,x=[]),x.push(a))}function D(){var a,c,d,e;e=d=b;a=t();a!==null?(c=u(),c!==null?a=[a,c]:(a=null,b=e)):(a=null,b=e);a!==null&&(a={type:"cfiString",path:a[0],localPath:a[1]});a===null&&(b=
d);return a}function u(){var a,c,d,e;e=d=b;c=t();c===null&&(c=y());if(c!==null)for(a=[];c!==null;)a.push(c),c=t(),c===null&&(c=y());else a=null;a!==null?(c=E(),c=c!==null?c:"",c!==null?a=[a,c]:(a=null,b=e)):(a=null,b=e);a!==null&&(a={steps:a[0],termStep:a[1]});a===null&&(b=d);return a}function t(){var a,c,d,e,i,k,j,l;j=k=b;f.charCodeAt(b)===47?(a="/",b++):(a=null,h===0&&g('"/"'));a!==null?(c=v(),c!==null?(l=b,f.charCodeAt(b)===91?(d="[",b++):(d=null,h===0&&g('"["')),d!==null?(e=z(),e!==null?(f.charCodeAt(b)===
93?(i="]",b++):(i=null,h===0&&g('"]"')),i!==null?d=[d,e,i]:(d=null,b=l)):(d=null,b=l)):(d=null,b=l),d=d!==null?d:"",d!==null?a=[a,c,d]:(a=null,b=j)):(a=null,b=j)):(a=null,b=j);a!==null&&(a={type:"indexStep",stepLength:a[1],idAssertion:a[2][1]});a===null&&(b=k);return a}function y(){var a,c,d,e,i,k,j,l;j=k=b;f.substr(b,2)==="!/"?(a="!/",b+=2):(a=null,h===0&&g('"!/"'));a!==null?(c=v(),c!==null?(l=b,f.charCodeAt(b)===91?(d="[",b++):(d=null,h===0&&g('"["')),d!==null?(e=z(),e!==null?(f.charCodeAt(b)===
93?(i="]",b++):(i=null,h===0&&g('"]"')),i!==null?d=[d,e,i]:(d=null,b=l)):(d=null,b=l)):(d=null,b=l),d=d!==null?d:"",d!==null?a=[a,c,d]:(a=null,b=j)):(a=null,b=j)):(a=null,b=j);a!==null&&(a={type:"indirectionStep",stepLength:a[1],idAssertion:a[2][1]});a===null&&(b=k);return a}function E(){var a,c,d,e,i,k,j,l;j=k=b;f.charCodeAt(b)===58?(a=":",b++):(a=null,h===0&&g('":"'));a!==null?(c=v(),c!==null?(l=b,f.charCodeAt(b)===91?(d="[",b++):(d=null,h===0&&g('"["')),d!==null?(e=n(),e!==null?(f.charCodeAt(b)===
93?(i="]",b++):(i=null,h===0&&g('"]"')),i!==null?d=[d,e,i]:(d=null,b=l)):(d=null,b=l)):(d=null,b=l),d=d!==null?d:"",d!==null?a=[a,c,d]:(a=null,b=j)):(a=null,b=j)):(a=null,b=j);a!==null&&(a={type:"textTerminus",offsetValue:a[1],textAssertion:a[2][1]});a===null&&(b=k);return a}function z(){var a,c;c=b;a=w();a===null&&(b=c);return a}function n(){var a,c,d,e;e=d=b;a=F();a=a!==null?a:"";a!==null?(c=G(),c=c!==null?c:"",c!==null?a=[a,c]:(a=null,b=e)):(a=null,b=e);a!==null&&(a={type:"textLocationAssertion",
csv:a[0],parameter:a[1]});a===null&&(b=d);return a}function G(){var a,c,d,e,i,k;k=i=b;f.charCodeAt(b)===59?(a=";",b++):(a=null,h===0&&g('";"'));a!==null?(c=A(),c!==null?(f.charCodeAt(b)===61?(d="=",b++):(d=null,h===0&&g('"="')),d!==null?(e=A(),e!==null?a=[a,c,d,e]:(a=null,b=k)):(a=null,b=k)):(a=null,b=k)):(a=null,b=k);a!==null&&(a={type:"parameter",LHSValue:a[1],RHSValue:a[3]});a===null&&(b=i);return a}function F(){var a,c,d,e,i;i=e=b;a=w();a=a!==null?a:"";a!==null?(f.charCodeAt(b)===44?(c=",",b++):
(c=null,h===0&&g('","')),c!==null?(d=w(),d=d!==null?d:"",d!==null?a=[a,c,d]:(a=null,b=i)):(a=null,b=i)):(a=null,b=i);a!==null&&(a={type:"csv",preAssertion:a[0],postAssertion:a[2]});a===null&&(b=e);return a}function A(){var a,c,d;d=b;c=r();c===null&&(c=s());if(c!==null)for(a=[];c!==null;)a.push(c),c=r(),c===null&&(c=s());else a=null;a!==null&&(a=a.join(""));a===null&&(b=d);return a}function w(){var a,c,d;d=b;c=r();c===null&&(c=s(),c===null&&(c=B()));if(c!==null)for(a=[];c!==null;)a.push(c),c=r(),c===
null&&(c=s(),c===null&&(c=B()));else a=null;a!==null&&(a=a.join(""));a===null&&(b=d);return a}function r(){var a,c,d,e;e=d=b;a=p();a!==null?(c=p(),c!==null?a=[a,c]:(a=null,b=e)):(a=null,b=e);a===null&&(e=b,a=p(),a!==null?(c=H(),c!==null?a=[a,c]:(a=null,b=e)):(a=null,b=e),a===null&&(e=b,a=p(),a!==null?(c=I(),c!==null?a=[a,c]:(a=null,b=e)):(a=null,b=e),a===null&&(e=b,a=p(),a!==null?(c=J(),c!==null?a=[a,c]:(a=null,b=e)):(a=null,b=e),a===null&&(e=b,a=p(),a!==null?(c=K(),c!==null?a=[a,c]:(a=null,b=e)):
(a=null,b=e),a===null&&(e=b,a=p(),a!==null?(c=L(),c!==null?a=[a,c]:(a=null,b=e)):(a=null,b=e))))));a!==null&&(a=a[1]);a===null&&(b=d);return a}function v(){var a,c,d,e,i;e=b;f.charCodeAt(b)===48?(a="0",b++):(a=null,h===0&&g('"0"'));if(a===null)if(i=b,/^[1-9]/.test(f.charAt(b))?(a=f.charAt(b),b++):(a=null,h===0&&g("[1-9]")),a!==null){c=[];/^[0-9]/.test(f.charAt(b))?(d=f.charAt(b),b++):(d=null,h===0&&g("[0-9]"));for(;d!==null;)c.push(d),/^[0-9]/.test(f.charAt(b))?(d=f.charAt(b),b++):(d=null,h===0&&
g("[0-9]"));c!==null?a=[a,c]:(a=null,b=i)}else a=null,b=i;a!==null&&(a=a==="0"?"0":a[0].concat(a[1].join("")));a===null&&(b=e);return a}function B(){var a,c;c=b;f.charCodeAt(b)===32?(a=" ",b++):(a=null,h===0&&g('" "'));a!==null&&(a=" ");a===null&&(b=c);return a}function p(){var a,c;c=b;f.charCodeAt(b)===94?(a="^",b++):(a=null,h===0&&g('"^"'));a!==null&&(a="^");a===null&&(b=c);return a}function H(){var a,c;c=b;f.charCodeAt(b)===91?(a="[",b++):(a=null,h===0&&g('"["'));a===null&&(f.charCodeAt(b)===93?
(a="]",b++):(a=null,h===0&&g('"]"')));a===null&&(b=c);return a}function I(){var a,c;c=b;f.charCodeAt(b)===40?(a="(",b++):(a=null,h===0&&g('"("'));a===null&&(f.charCodeAt(b)===41?(a=")",b++):(a=null,h===0&&g('")"')));a===null&&(b=c);return a}function J(){var a,c;c=b;f.charCodeAt(b)===44?(a=",",b++):(a=null,h===0&&g('","'));a!==null&&(a=",");a===null&&(b=c);return a}function K(){var a,c;c=b;f.charCodeAt(b)===59?(a=";",b++):(a=null,h===0&&g('";"'));a!==null&&(a=";");a===null&&(b=c);return a}function L(){var a,
c;c=b;f.charCodeAt(b)===61?(a="=",b++):(a=null,h===0&&g('"="'));a!==null&&(a="=");a===null&&(b=c);return a}function s(){var a,c;c=b;/^[a-z]/.test(f.charAt(b))?(a=f.charAt(b),b++):(a=null,h===0&&g("[a-z]"));a===null&&(/^[A-Z]/.test(f.charAt(b))?(a=f.charAt(b),b++):(a=null,h===0&&g("[A-Z]")),a===null&&(/^[0-9]/.test(f.charAt(b))?(a=f.charAt(b),b++):(a=null,h===0&&g("[0-9]"))));a===null&&(b=c);return a}function N(a){a.sort();for(var b=null,d=[],e=0;e<a.length;e++)a[e]!==b&&(d.push(a[e]),b=a[e]);return d}
function O(){for(var a=1,c=1,d=!1,e=0;e<Math.max(b,q);e++){var g=f.charAt(e);g==="\n"?(d||a++,c=1,d=!1):g==="\r"||g==="\u2028"||g==="\u2029"?(a++,c=1,d=!0):(c++,d=!1)}return{line:a,column:c}}var o={fragment:function(){var a,c,d,e,i;i=e=b;f.substr(b,8)==="epubcfi("?(a="epubcfi(",b+=8):(a=null,h===0&&g('"epubcfi("'));a!==null?(c=D(),c!==null?(f.charCodeAt(b)===41?(d=")",b++):(d=null,h===0&&g('")"')),d!==null?a=[a,c,d]:(a=null,b=i)):(a=null,b=i)):(a=null,b=i);a!==null&&(a={type:"CFIAST",cfiString:a[1]});
a===null&&(b=e);return a},path:D,local_path:u,indexStep:t,indirectionStep:y,terminus:E,idAssertion:z,textLocationAssertion:n,parameter:G,csv:F,valueNoSpace:A,value:w,escapedSpecialChars:r,number:function(){var a,c,d,e,i,k,j;j=k=i=b;/^[1-9]/.test(f.charAt(b))?(a=f.charAt(b),b++):(a=null,h===0&&g("[1-9]"));if(a!==null){/^[0-9]/.test(f.charAt(b))?(d=f.charAt(b),b++):(d=null,h===0&&g("[0-9]"));if(d!==null)for(c=[];d!==null;)c.push(d),/^[0-9]/.test(f.charAt(b))?(d=f.charAt(b),b++):(d=null,h===0&&g("[0-9]"));
else c=null;c!==null?a=[a,c]:(a=null,b=j)}else a=null,b=j;if(a!==null)if(f.charCodeAt(b)===46?(c=".",b++):(c=null,h===0&&g('"."')),c!==null){j=b;d=[];/^[0-9]/.test(f.charAt(b))?(e=f.charAt(b),b++):(e=null,h===0&&g("[0-9]"));for(;e!==null;)d.push(e),/^[0-9]/.test(f.charAt(b))?(e=f.charAt(b),b++):(e=null,h===0&&g("[0-9]"));d!==null?(/^[1-9]/.test(f.charAt(b))?(e=f.charAt(b),b++):(e=null,h===0&&g("[1-9]")),e!==null?d=[d,e]:(d=null,b=j)):(d=null,b=j);d!==null?a=[a,c,d]:(a=null,b=k)}else a=null,b=k;else a=
null,b=k;a!==null&&(a=a[0].join("")+"."+a[2].join(""));a===null&&(b=i);return a},integer:v,space:B,circumflex:p,doubleQuote:function(){var a,c;c=b;f.charCodeAt(b)===34?(a='"',b++):(a=null,h===0&&g('"\\""'));a!==null&&(a='"');a===null&&(b=c);return a},squareBracket:H,parentheses:I,comma:J,semicolon:K,equal:L,character:s};if(m!==void 0){if(o[m]===void 0)throw Error("Invalid rule name: "+C(m)+".");}else m="fragment";var b=0,h=0,q=0,x=[],o=o[m]();if(o===null||b!==f.length){var o=Math.max(b,q),P=o<f.length?
f.charAt(o):null,M=O();throw new this.SyntaxError(N(x),P,o,M.line,M.column);}return o},toSource:function(){return this._source},SyntaxError:function(f,m,g,n,u){this.name="SyntaxError";this.expected=f;this.found=m;this.message=function(f,g){var m,n;switch(f.length){case 0:m="end of input";break;case 1:m=f[0];break;default:m=f.slice(0,f.length-1).join(", ")+" or "+f[f.length-1]}n=g?C(g):"end of input";return"Expected "+m+" but "+n+" found."}(f,m);this.offset=g;this.line=n;this.column=u}};n.SyntaxError.prototype=
Error.prototype;return n}();
